<Blank>:
    Label: 
        center: root.center 
        text: root.label

<Conditional>: 
    canvas: 
        Color: 
            rgba: root.line_color
        Line: 
            width: 2.
            points: (self.center_x, self.y, self.x, self.center_y, self.center_x, self.y + self.height, self.x + self.width, self.center_y)
            close: True
    Label: 
        center: root.center 
        text: root.label

<Statement>:
    canvas: 
        Color: 
            rgba: root.line_color
        Line: 
            width: 2.
            rectangle: (self.x, self.y, self.width, self.height)
    Label: 
        center: root.center 
        text: root.label

<UpArrow>:
    canvas: 
        Color: 
            rgba: root.line_color
        Line: 
            width: 2.
            points:
                (self.x, self.y,
                self.center_x, self.y + self.height,
                self.x + self.width, self.y)

<DownArrow>:
    canvas: 
        Color: 
            rgba: root.line_color
        Line: 
            width: 2.
            points:
                (self.x, self.y + self.height,
                self.center_x, self.y,
                self.x + self.width, self.y + self.height)

<LeftArrow>:
    canvas: 
        Color: 
            rgba: root.line_color
        Line: 
            width: 2.
            points:
                (self.x + self.width, self.y + self.height,
                self.x, self.center_y,
                self.x + self.width, self.y)

<RightArrow>:
    canvas: 
        Color: 
            rgba: root.line_color
        Line: 
            width: 2.
            points:
                (self.x, self.y + self.height,
                self.x + self.width, self.center_y,
                self.x, self.y)

<HorizontalLine>:
    canvas: 
        Color: 
            rgba: root.line_color
        Line: 
            width: 2.
            points: (self.x, self.center_y, self.x + self.width, self.center_y)

<VerticalLine>:
    canvas: 
        Color: 
            rgba: root.line_color
        Line: 
            width: 2.
            points: (self.center_x, self.y, self.center_x, self.y + self.height)

<Connector>:
    VerticalLine:
        line_color: (root.line_color[0], root.line_color[1], root.line_color[2], 1 if root.line_n else 0)
        x: root.x
        y: root.center_y
        size: (root.width, root.height / 2)
    VerticalLine:
        line_color: (root.line_color[0], root.line_color[1], root.line_color[2], 1 if root.line_s else 0)
        x: root.x
        y: root.y
        size: (root.width, root.height / 2)
    HorizontalLine:
        line_color: (root.line_color[0], root.line_color[1], root.line_color[2], 1 if root.line_e else 0)
        x: root.center_x
        y: root.y
        size: (root.width / 2, root.height)
    HorizontalLine:
        line_color: (root.line_color[0], root.line_color[1], root.line_color[2], 1 if root.line_w else 0)
        x: root.x
        y: root.y
        size: (root.width / 2, root.height)
    UpArrow:
        line_color: (root.line_color[0], root.line_color[1], root.line_color[2], 1 if root.arrow_n else 0)
        center_x: root.center_x
        y: root.y + root.height - self.height
        size: (16, 8)
    DownArrow:
        line_color: (root.line_color[0], root.line_color[1], root.line_color[2], 1 if root.arrow_s else 0)
        center_x: root.center_x
        y: root.y
        size: (16, 8)
    RightArrow:
        line_color: (root.line_color[0], root.line_color[1], root.line_color[2], 1 if root.arrow_e else 0)
        x: root.x + root.width - self.width
        center_y: root.center_y
        size: (8, 16)
    LeftArrow:
        line_color: (root.line_color[0], root.line_color[1], root.line_color[2], 1 if root.arrow_w else 0)
        x: root.x
        center_y: root.center_y
        size: (8, 16)
    Label:
        center: root.center
        text: root.label

<LoadDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: './'
            filters: ['*.cp']

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()
            Button:
                text: "Load"
                on_release: root.load(filechooser.path, filechooser.selection)

<SaveDialog>:
    text_input: text_input
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: './'
            filters: ['*.cp']
            on_selection: text_input.text = self.selection and self.selection[0] or ''

        TextInput:
            id: text_input
            size_hint_y: None
            height: 30
            multiline: False

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Save"
                on_release: root.save(filechooser.path, text_input.text)

<MainWindow>:

    text_input: text_input
    tape_input: tape_input

    BoxLayout:
        orientation: "horizontal"
        size: root.width, root.height

        # CP GUI Interface
        BoxLayout:
            orientation: "vertical"
            size_hint: None, None
            size: root.width * 0.67, root.height

            Label:
                text: 'Simulator'
                size_hint: None, None
                size: root.width * 0.67, root.height * 0.05

            BoxLayout:
                # tape input
                size_hint: 0.4, None
                size: root.width * 0.67, root.height * 0.05

                AnchorLayout:
                    size_hint: None, None
                    size: root.width * 0.3, root.height * 0.05

                    Label:
                        text: 'Tape Input: '
                        size_hint: None, None
                        text_size: self.size
                        size: root.width * 0.3, root.height * 0.05
                        halign: 'right'
                        valign: 'middle'

                # TODO: center the text input

                TextInput:
                    id: tape_input

                    hint_text: '0,0,0,0,0,...'
                    size_hint: None, None
                    pos_hint: {'x': 0, 'y': 0.15}
                    size: root.width * 0.3, root.height * 0.035
                    padding: [6, (self.height - self.line_height)/2]
                    multiline: False
                    on_text: root.on_text(tape_input.text)

            BoxLayout:
                id: flowchart
                pos_hint: {'x': 0, 'y': .1}
                size_hint: None, None
                size: root.width * 0.67, root.height * 0.75

            BoxLayout:
                # counter tape
                id: counter_tape
                size_hint: None, None
                size: root.width * 0.67, root.height * 0.05

            BoxLayout:
                orientation: "horizontal"
                size_hint: None, None
                size: root.width * 0.67, root.height * 0.091

                BoxLayout:
                    # this is a spacer
                    size_hint: None, None
                    size: root.width * 0.67 * 0.003, root.height * 0.097

                GridLayout:
                    cols: 2
                    size_hint: None, None
                    size: root.width * 0.67 * 0.334, root.height * 0.097

                    AnchorLayout:
                        Button:
                            text: "Pause" if root.running else "Run"
                            size_hint: 0.95, 0.8
                            on_release: root.run_or_pause_counter_program()
                            disabled: not root.step_state

                    AnchorLayout:
                        Button:
                            text: "Reset"
                            size_hint: 0.95, 0.8
                            on_release: root.reset_all()

                    BoxLayout:
                        Label:
                            text: "Delay (s)   "
                            size_hint: None, None
                            size: root.width * 0.67 * 0.335 * 0.27, root.height * 0.035
                            text_size: self.size
                            pos_hint: {'x': 0, 'y': 0.15}
                            halign: 'right'
                            valign: 'middle'

                        TextInput:
                            text: "0.1"
                            size_hint: None, None
                            pos_hint: {'x': 0, 'y': 0.15}
                            size: root.width * 0.67 * 0.335 * 0.215, root.height * 0.035
                            on_text: root.update_delay(self.text)

                    AnchorLayout:
                        Button:
                            text: "Reset"
                            size_hint: 0.95, 0.8


                BoxLayout:
                    orientation: "vertical"
                    size_hint: None, None
                    size: root.width * 0.67 * 0.33, root.height * 0.097

                    AnchorLayout:
                        Button:
                            text: "Step"
                            size_hint: 0.95 * 0.5, 0.8
                            on_release: root.step_counter_program()
                            disabled: not root.step_state or root.running

                    AnchorLayout:
                        Button:
                            text: "Step Back"
                            size_hint: 0.95 * 0.5, 0.8

                BoxLayout:
                    orientation: "vertical"
                    size_hint: None, None
                    size: root.width * 0.67 * 0.333, root.height * 0.097

                    Label:
                        text: "State: 0"
                    Label:
                        text: "Step: " + str(root.counter_program_step)

            BoxLayout:
                # this is a spacer
                size_hint: None, None
                size: root.width * 0.67, root.height * 0.003

        # CP Editor
        BoxLayout:
            orientation: "vertical"
            size_hint: None, None
            size: root.width * 0.33, root.height

            Label:
                text: 'Editor:'
                size_hint: None, None
                size: root.width * 0.33, root.height * 0.05

            AnchorLayout:
                CodeInput:
                    id: text_input
                    text: ''
                    lexer: root.CPLexer()
                    style: root.GruvboxStyle
                    background_color: (0.16, 0.16, 0.16, 1)
                    foreground_color: (0, 0, 0, 1)
                    font_size: 14
                    font_name: 'FiraMono-Regular'
                    size_hint_x: .95
                    pos_hint: {'x': 0.025, 'y': 0.025}
                    size: root.width * 0.33, root.height * 0.90

            BoxLayout:
                orientation: "horizontal"
                size_hint : None, None
                size: root.width * 0.33, root.height * 0.1

                AnchorLayout:
                    Button:
                        text: 'Load'
                        size_hint: 0.6, 0.4
                        on_release: root.file_chooser()

                AnchorLayout:
                    Button:
                        text: 'Save'
                        size_hint: 0.6, 0.4
                        on_release: root.file_saver()




